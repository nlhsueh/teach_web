{% extends "template.html" %}

{% block title %}個人資訊{% endblock %}

<!-- for vscode -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

{% block style %}

<style>
    .upload_zone_enter {
        border: 10px dashed rgb(30, 116, 173);
        background-clip: content-box;
    }

    .obj {
        width: 100%;
        height: 100%;
        aspect-ratio: 1 / 1;
    }
</style>

{% endblock %}

{% block content %}

<div class="section container">
    <div>

        <h3>個人資訊設定</h3>

        <form action="/profile/" method="post" enctype="multipart/form-data">
            {% csrf_token %}

            {% if form_messages %}
            <div class="text-danger text-center m-3">{{ form_messages }}</div>
            {% endif %}

            <div class="d-flex">
                <div class="w-75">

                    <div class="form-floating mb-3">
                        <input class="form-control shadow-none {% if form.username.errors.0 %}is-invalid{% endif %}"
                            name="username" placeholder="使用者名稱" value="{{ user.username }}">
                        <label>使用者名稱</label>
                        <div class="invalid-feedback">{{ form.username.errors.0 }}</div>
                    </div>

                    <div class="form-floating mb-3">
                        <input class="form-control shadow-none {% if form.account.errors.0 %}is-invalid{% endif %}"
                            name="account" placeholder="帳號" value="{{ user.account }}" readonly>
                        <label>帳號</label>
                        <div class="invalid-feedback">{{ form.account.errors.0 }}</div>
                    </div>

                    <div class="form-floating mb-3">
                        <input class="form-control shadow-none {% if form.password.errors.0 %}is-invalid{% endif %}"
                            name="password" placeholder="密碼" type="password" value="{{ user.password }}">
                        <label>密碼</label>
                        <div class="invalid-feedback">{{ form.password.errors.0 }}</div>
                    </div>

                    <div class="form-floating mb-3">
                        <input class="form-control shadow-none {% if form.r_password.errors.0 %}is-invalid{% endif %}"
                            name="r_password" type="password" placeholder="確認密碼" value="{{ user.password }}">
                        <label>確認密碼</label>
                        <div class="invalid-feedback">{{ form.r_password.errors.0 }}</div>
                    </div>

                    <div class="form-floating mb-3">
                        <input class="form-control shadow-none {% if form.description.errors.0 %}is-invalid{% endif %}"
                            name="description" placeholder="自我介紹" value="{% if user.description %}{{ user.description }}{% endif %}">
                        <label>自我介紹</label>
                        <div class="invalid-feedback">{{ form.description.errors.0 }}</div>
                    </div>
                </div>

                <div class="w-25 ms-2 d-flex align-items-center">
                    <!-- 參考資料 : https://www.oxxostudio.tw/articles/201412/css-boxsizing-backgroundclip.html  -->
                    <input type="file" accept="image/*" id="fileUploader" class="d-none" onchange="handleFiles(this.files)"
                        name="avatar" />

                    <div id="upload_zone" class="w-100 hover border p-3" role="button">
                        {% if not user.avatar %}
                        <svg xmlns="http://www.w3.org/2000/svg" fill="gray" viewBox="0 0 448 512">
                            <path
                                d="M224 256A128 128 0 1 0 224 0a128 128 0 1 0 0 256zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z" />
                        </svg>
                        {% else %}
                        <img class="obj rounded-circle" src="/media/{{user.avatar}}" alt="">
                        {% endif %}
                    </div>
                </div>
            </div>

            <button type="submit" class="btn btn-danger">確認</button>
        </form>
    </div>
</div>

<script>
    const dropbox = document.getElementById("upload_zone");

    function handleFileSelect(e) {
        e.stopPropagation();
        e.preventDefault();
        const fileUploader = document.getElementById("fileUploader");
        fileUploader.click();
    }

    const click = e => handleFileSelect(e);

    // prevent the default method working
    function dragenter(e) {
        // add the styling to div
        dropbox.classList.add("upload_zone_enter");
        e.stopPropagation();
        e.preventDefault();
    }

    const dragleave = () => dropbox.classList.remove("upload_zone_enter");

    // prevent the default method working
    function dragover(e) {
        e.stopPropagation();
        e.preventDefault();
    }

    function handleFiles(files) {
        for (var i = 0; i < files.length; i++) {
            const file = files[i];
            const imageType = /image.*/;

            if (!file.type.match(imageType)) {
                continue;
            }

            const img = document.createElement("img");
            img.classList.add("obj");
            img.classList.add("rounded-circle")
            img.file = file;
            upload_zone.innerHTML = ''
            upload_zone.appendChild(img);

            const reader = new FileReader();
            reader.onload = (e => img.src = e.target.result);
            reader.readAsDataURL(file);
        }
    }

    function drop(e) {
        e.stopPropagation();
        e.preventDefault();

        const dt = e.dataTransfer;
        const files = dt.files;

        handleFiles(files);
        dropbox.classList.remove("upload_zone_enter");
    }

    dropbox.addEventListener("click", click, false);
    dropbox.addEventListener("dragenter", dragenter, false);
    dropbox.addEventListener("dragleave", dragleave, false);
    dropbox.addEventListener("dragover", dragover, false);
    dropbox.addEventListener("drop", drop, false);
</script>

{% endblock %}